function defaultScene(){return{things:[new Plane(new Vector(0,1,0),0,Surfaces.checkerboard),new Sphere(new Vector(0,1,-.25),1,Surfaces.shiny),new Sphere(new Vector(-1,.5,1.5),.5,Surfaces.shiny)],lights:[{pos:new Vector(-2,2.5,0),color:new Color(.49,.07,.07)},{pos:new Vector(1.5,2.5,1.5),color:new Color(.07,.07,.49)},{pos:new Vector(1.5,2.5,-1.5),color:new Color(.07,.49,.071)},{pos:new Vector(0,3.5,0),color:new Color(.21,.21,.35)}],camera:new Camera(new Vector(3,2,4),new Vector(-1,.5,0))}}function exec(){var r=document.createElement("canvas");r.width=256,r.height=256,document.body.appendChild(r);var t=r.getContext("2d"),e=new RayTracer;return e.render(defaultScene(),t,256,256)}var Greeter=function(){function r(r){this.greeting=r}return r.prototype.greet=function(){return"<h1>"+this.greeting+"</h1>"},r}(),greeter=new Greeter("Hello, world!");document.body.innerHTML=greeter.greet();var Vector=function(){function r(r,t,e){this.x=r,this.y=t,this.z=e}return r.times=function(t,e){return new r(t*e.x,t*e.y,t*e.z)},r.minus=function(t,e){return new r(t.x-e.x,t.y-e.y,t.z-e.z)},r.plus=function(t,e){return new r(t.x+e.x,t.y+e.y,t.z+e.z)},r.dot=function(r,t){return r.x*t.x+r.y*t.y+r.z*t.z},r.mag=function(r){return Math.sqrt(r.x*r.x+r.y*r.y+r.z*r.z)},r.norm=function(t){var e=r.mag(t),o=0===e?1/0:1/e;return r.times(o,t)},r.cross=function(t,e){return new r(t.y*e.z-t.z*e.y,t.z*e.x-t.x*e.z,t.x*e.y-t.y*e.x)},r}(),Color=function(){function r(r,t,e){this.r=r,this.g=t,this.b=e}return r.scale=function(t,e){return new r(t*e.r,t*e.g,t*e.b)},r.plus=function(t,e){return new r(t.r+e.r,t.g+e.g,t.b+e.b)},r.times=function(t,e){return new r(t.r*e.r,t.g*e.g,t.b*e.b)},r.toDrawingColor=function(r){var t=function(r){return r>1?1:r};return{r:Math.floor(255*t(r.r)),g:Math.floor(255*t(r.g)),b:Math.floor(255*t(r.b))}},r.white=new r(1,1,1),r.grey=new r(.5,.5,.5),r.black=new r(0,0,0),r.background=r.black,r.defaultColor=r.black,r}(),Camera=function(){function r(r,t){this.pos=r;var e=new Vector(0,-1,0);this.forward=Vector.norm(Vector.minus(t,this.pos)),this.right=Vector.times(1.5,Vector.norm(Vector.cross(this.forward,e))),this.up=Vector.times(1.5,Vector.norm(Vector.cross(this.forward,this.right)))}return r}(),Sphere=function(){function r(r,t,e){this.center=r,this.surface=e,this.radius2=t*t}return r.prototype.normal=function(r){return Vector.norm(Vector.minus(r,this.center))},r.prototype.intersect=function(r){var t=Vector.minus(this.center,r.start),e=Vector.dot(t,r.dir),o=0;if(e>=0){var n=this.radius2-(Vector.dot(t,t)-e*e);n>=0&&(o=e-Math.sqrt(n))}return 0===o?null:{thing:this,ray:r,dist:o}},r}(),Plane=function(){function r(r,t,e){this.surface=e,this.normal=function(t){return r},this.intersect=function(e){var o=Vector.dot(r,e.dir);if(o>0)return null;var n=(Vector.dot(r,e.start)+t)/-o;return{thing:this,ray:e,dist:n}}}return r}(),Surfaces;!function(r){r.shiny={diffuse:function(r){return Color.white},specular:function(r){return Color.grey},reflect:function(r){return.7},roughness:250},r.checkerboard={diffuse:function(r){return(Math.floor(r.z)+Math.floor(r.x))%2!==0?Color.white:Color.black},specular:function(r){return Color.white},reflect:function(r){return(Math.floor(r.z)+Math.floor(r.x))%2!==0?.1:.7},roughness:150}}(Surfaces||(Surfaces={}));var RayTracer=function(){function r(){this.maxDepth=5}return r.prototype.intersections=function(r,t){var e=+(1/0),o=void 0;for(var n in t.things){var i=t.things[n].intersect(r);null!=i&&i.dist<e&&(o=i,e=i.dist)}return o},r.prototype.testRay=function(r,t){var e=this.intersections(r,t);return null!=e?e.dist:void 0},r.prototype.traceRay=function(r,t,e){var o=this.intersections(r,t);return void 0===o?Color.background:this.shade(o,t,e)},r.prototype.shade=function(r,t,e){var o=r.ray.dir,n=Vector.plus(Vector.times(r.dist,o),r.ray.start),i=r.thing.normal(n),c=Vector.minus(o,Vector.times(2,Vector.times(Vector.dot(i,o),i))),u=Color.plus(Color.background,this.getNaturalColor(r.thing,n,i,c,t)),s=e>=this.maxDepth?Color.grey:this.getReflectionColor(r.thing,n,i,c,t,e);return Color.plus(u,s)},r.prototype.getReflectionColor=function(r,t,e,o,n,i){return Color.scale(r.surface.reflect(t),this.traceRay({start:t,dir:o},n,i+1))},r.prototype.getNaturalColor=function(r,t,e,o,n){var i=this,c=function(c,u){var s=Vector.minus(u.pos,t),a=Vector.norm(s),l=i.testRay({start:t,dir:a},n),f=void 0===l?!1:l<=Vector.mag(s);if(f)return c;var h=Vector.dot(a,e),d=h>0?Color.scale(h,u.color):Color.defaultColor,g=Vector.dot(a,Vector.norm(o)),p=g>0?Color.scale(Math.pow(g,r.surface.roughness),u.color):Color.defaultColor;return Color.plus(c,Color.plus(Color.times(r.surface.diffuse(t),d),Color.times(r.surface.specular(t),p)))};return n.lights.reduce(c,Color.defaultColor)},r.prototype.render=function(r,t,e,o){for(var n=function(r,t,n){var i=function(r){return(r-e/2)/2/e},c=function(r){return-(r-o/2)/2/o};return Vector.norm(Vector.plus(n.forward,Vector.plus(Vector.times(i(r),n.right),Vector.times(c(t),n.up))))},i=0;o>i;i++)for(var c=0;e>c;c++){var u=this.traceRay({start:r.camera.pos,dir:n(c,i,r.camera)},r,0),s=Color.toDrawingColor(u);t.fillStyle="rgb("+String(s.r)+", "+String(s.g)+", "+String(s.b)+")",t.fillRect(c,i,c+1,i+1)}},r}();exec();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyJdLCJuYW1lcyI6WyJkZWZhdWx0U2NlbmUiLCJ0aGluZ3MiLCJQbGFuZSIsIlZlY3RvciIsIlN1cmZhY2VzIiwiY2hlY2tlcmJvYXJkIiwiU3BoZXJlIiwic2hpbnkiLCJsaWdodHMiLCJwb3MiLCJjb2xvciIsIkNvbG9yIiwiY2FtZXJhIiwiQ2FtZXJhIiwiZXhlYyIsImNhbnYiLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJ3aWR0aCIsImhlaWdodCIsImJvZHkiLCJhcHBlbmRDaGlsZCIsImN0eCIsImdldENvbnRleHQiLCJyYXlUcmFjZXIiLCJSYXlUcmFjZXIiLCJyZW5kZXIiLCJHcmVldGVyIiwiZ3JlZXRpbmciLCJ0aGlzIiwicHJvdG90eXBlIiwiZ3JlZXQiLCJncmVldGVyIiwiaW5uZXJIVE1MIiwieCIsInkiLCJ6IiwidGltZXMiLCJrIiwidiIsIm1pbnVzIiwidjEiLCJ2MiIsInBsdXMiLCJkb3QiLCJtYWciLCJNYXRoIiwic3FydCIsIm5vcm0iLCJkaXYiLCJJbmZpbml0eSIsImNyb3NzIiwiciIsImciLCJiIiwic2NhbGUiLCJ0b0RyYXdpbmdDb2xvciIsImMiLCJsZWdhbGl6ZSIsImQiLCJmbG9vciIsIndoaXRlIiwiZ3JleSIsImJsYWNrIiwiYmFja2dyb3VuZCIsImRlZmF1bHRDb2xvciIsImxvb2tBdCIsImRvd24iLCJmb3J3YXJkIiwicmlnaHQiLCJ1cCIsImNlbnRlciIsInJhZGl1cyIsInN1cmZhY2UiLCJyYWRpdXMyIiwibm9ybWFsIiwiaW50ZXJzZWN0IiwicmF5IiwiZW8iLCJzdGFydCIsImRpciIsImRpc3QiLCJkaXNjIiwidGhpbmciLCJvZmZzZXQiLCJkZW5vbSIsImRpZmZ1c2UiLCJzcGVjdWxhciIsInJlZmxlY3QiLCJyb3VnaG5lc3MiLCJtYXhEZXB0aCIsImludGVyc2VjdGlvbnMiLCJzY2VuZSIsImNsb3Nlc3QiLCJjbG9zZXN0SW50ZXIiLCJ1bmRlZmluZWQiLCJpIiwiaW50ZXIiLCJ0ZXN0UmF5IiwiaXNlY3QiLCJ0cmFjZVJheSIsImRlcHRoIiwic2hhZGUiLCJyZWZsZWN0RGlyIiwibmF0dXJhbENvbG9yIiwiZ2V0TmF0dXJhbENvbG9yIiwicmVmbGVjdGVkQ29sb3IiLCJnZXRSZWZsZWN0aW9uQ29sb3IiLCJyZCIsIl90aGlzIiwiYWRkTGlnaHQiLCJjb2wiLCJsaWdodCIsImxkaXMiLCJsaXZlYyIsIm5lYXRJc2VjdCIsImlzSW5TaGFkb3ciLCJpbGx1bSIsImxjb2xvciIsInNjb2xvciIsInBvdyIsInJlZHVjZSIsInNjcmVlbldpZHRoIiwic2NyZWVuSGVpZ2h0IiwiZ2V0UG9pbnQiLCJyZWNlbnRlclgiLCJyZWNlbnRlclkiLCJmaWxsU3R5bGUiLCJTdHJpbmciLCJmaWxsUmVjdCJdLCJtYXBwaW5ncyI6IkFBMFFBLFFBQVNBLGdCQUNMLE9BQ0lDLFFBQVMsR0FBSUMsT0FBTSxHQUFJQyxRQUFPLEVBQUssRUFBSyxHQUFNLEVBQUtDLFNBQVNDLGNBQ3hELEdBQUlDLFFBQU8sR0FBSUgsUUFBTyxFQUFLLEdBQU0sS0FBTyxFQUFLQyxTQUFTRyxPQUN0RCxHQUFJRCxRQUFPLEdBQUlILFFBQU8sR0FBTSxHQUFLLEtBQU0sR0FBS0MsU0FBU0csUUFFekRDLFNBQ0lDLElBQUssR0FBSU4sUUFBTyxHQUFNLElBQUssR0FDM0JPLE1BQU8sR0FBSUMsT0FBTSxJQUFNLElBQU0sT0FFN0JGLElBQUssR0FBSU4sUUFBTyxJQUFLLElBQUssS0FDMUJPLE1BQU8sR0FBSUMsT0FBTSxJQUFNLElBQU0sT0FFN0JGLElBQUssR0FBSU4sUUFBTyxJQUFLLElBQUssTUFDMUJPLE1BQU8sR0FBSUMsT0FBTSxJQUFNLElBQU0sUUFFN0JGLElBQUssR0FBSU4sUUFBTyxFQUFLLElBQUssR0FDMUJPLE1BQU8sR0FBSUMsT0FBTSxJQUFNLElBQU0sT0FFakNDLE9BQVEsR0FBSUMsUUFBTyxHQUFJVixRQUFPLEVBQUssRUFBSyxHQUFNLEdBQUlBLFFBQU8sR0FBTSxHQUFLLEtBSTVFLFFBQVNXLFFBQ0wsR0FBSUMs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dUUsVUFDYnJCLE1BQU9hLEVBQU1oRixPQUFPSCxJQUNwQnVFLElBQUs0QyxFQUFTMUYsRUFBR0MsRUFBR3lELEVBQU1oRixTQUMzQmdGLEVBQU8sR0FDTm5DLEVBQUk5QyxNQUFNNkMsZUFBZTlDLEVBQzdCWSxHQUFJeUcsVUFBWSxPQUFTQyxPQUFPdkUsRUFBRUwsR0FBSyxLQUFPNEUsT0FBT3ZFLEVBQUVKLEdBQUssS0FBTzJFLE9BQU92RSxFQUFFSCxHQUFLLElBQ2pGaEMsRUFBSTJHLFNBQVMvRixFQUFHQyxFQUFHRCxFQUFJLEVBQUdDLEVBQUksS0FJbkNWLElBbUNYWCIsImZpbGUiOiJhcHAubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIEdyZWV0ZXIgPSAoZnVuY3Rpb24oKSB7XG4gICAgZnVuY3Rpb24gR3JlZXRlcihncmVldGluZykge1xuICAgICAgICB0aGlzLmdyZWV0aW5nID0gZ3JlZXRpbmc7XG4gICAgfVxuICAgIEdyZWV0ZXIucHJvdG90eXBlLmdyZWV0ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiBcIjxoMT5cIiArIHRoaXMuZ3JlZXRpbmcgKyBcIjwvaDE+XCI7XG4gICAgfTtcbiAgICByZXR1cm4gR3JlZXRlcjtcbn0oKSk7O1xudmFyIGdyZWV0ZXIgPSBuZXcgR3JlZXRlcihcIkhlbGxvLCB3b3JsZCFcIik7XG5kb2N1bWVudC5ib2R5LmlubmVySFRNTCA9IGdyZWV0ZXIuZ3JlZXQoKTtcbnZhciBWZWN0b3IgPSAoZnVuY3Rpb24oKSB7XG4gICAgZnVuY3Rpb24gVmVjdG9yKHgsIHksIHopIHtcbiAgICAgICAgdGhpcy54ID0geDtcbiAgICAgICAgdGhpcy55ID0geTtcbiAgICAgICAgdGhpcy56ID0gejtcbiAgICB9XG4gICAgVmVjdG9yLnRpbWVzID0gZnVuY3Rpb24oaywgdikge1xuICAgICAgICByZXR1cm4gbmV3IFZlY3RvcihrICogdi54LCBrICogdi55LCBrICogdi56KTtcbiAgICB9O1xuICAgIFZlY3Rvci5taW51cyA9IGZ1bmN0aW9uKHYxLCB2Mikge1xuICAgICAgICByZXR1cm4gbmV3IFZlY3Rvcih2MS54IC0gdjIueCwgdjEueSAtIHYyLnksIHYxLnogLSB2Mi56KTtcbiAgICB9O1xuICAgIFZlY3Rvci5wbHVzID0gZnVuY3Rpb24odjEsIHYyKSB7XG4gICAgICAgIHJldHVybiBuZXcgVmVjdG9yKHYxLnggKyB2Mi54LCB2MS55ICsgdjIueSwgdjEueiArIHYyLnopO1xuICAgIH07XG4gICAgVmVjdG9yLmRvdCA9IGZ1bmN0aW9uKHYxLCB2Mikge1xuICAgICAgICByZXR1cm4gdjEueCAqIHYyLnggKyB2MS55ICogdjIueSArIHYxLnogKiB2Mi56O1xuICAgIH07XG4gICAgVmVjdG9yLm1hZyA9IGZ1bmN0aW9uKHYpIHtcbiAgICAgICAgcmV0dXJuIE1hdGguc3FydCh2LnggKiB2LnggKyB2LnkgKiB2LnkgKyB2LnogKiB2LnopO1xuICAgIH07XG4gICAgVmVjdG9yLm5vcm0gPSBmdW5jdGlvbih2KSB7XG4gICAgICAgIHZhciBtYWcgPSBWZWN0b3IubWFnKHYpO1xuICAgICAgICB2YXIgZGl2ID0gKG1hZyA9PT0gMCkgPyBJbmZpbml0eSA6IDEuMCAvIG1hZztcbiAgICAgICAgcmV0dXJuIFZlY3Rvci50aW1lcyhkaXYsIHYpO1xuICAgIH07XG4gICAgVmVjdG9yLmNyb3NzID0gZnVuY3Rpb24odjEsIHYyKSB7XG4gICAgICAgIHJldHVybiBuZXcgVmVjdG9yKHYxLnkgKiB2Mi56IC0gdjEueiAqIHYyLnksIHYxLnogKiB2Mi54IC0gdjEueCAqIHYyLnosIHYxLnggKiB2Mi55IC0gdjEueSAqIHYyLngpO1xuICAgIH07XG4gICAgcmV0dXJuIFZlY3Rvcjtcbn0oKSk7XG52YXIgQ29sb3IgPSAoZnVuY3Rpb24oKSB7XG4gICAgZnVuY3Rpb24gQ29sb3IociwgZywgYikge1xuICAgICAgICB0aGlzLnIgPSByO1xuICAgICAgICB0aGlzLmcgPSBnO1xuICAgICAgICB0aGlzLmIgPSBiO1xuICAgIH1cbiAgICBDb2xvci5zY2FsZSA9IGZ1bmN0aW9uKGssIHYpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBDb2xvcihrICogdi5yLCBrICogdi5nLCBrICogdi5iKTtcbiAgICB9O1xuICAgIENvbG9yLnBsdXMgPSBmdW5jdGlvbih2MSwgdjIpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBDb2xvcih2MS5yICsgdjIuciwgdjEuZyArIHYyLmcsIHYxLmIgKyB2Mi5iKTtcbiAgICB9O1xuICAgIENvbG9yLnRpbWVzID0gZnVuY3Rpb24odjEsIHYyKSB7XG4gICAgICAgIHJldHVybiBuZXcgQ29sb3IodjEuciAqIHYyLnIsIHYxLmcgKiB2Mi5nLCB2MS5iICogdjIuYik7XG4gICAgfTtcbiAgICBDb2xvci50b0RyYXdpbmdDb2xvciA9IGZ1bmN0aW9uKGMpIHtcbiAgICAgICAgdmFyIGxlZ2FsaXplID0gZnVuY3Rpb24oZCkge1xuICAgICAgICAgICAgcmV0dXJuIGQgPiAxID8gMSA6IGQ7XG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICByOiBNYXRoLmZsb29yKGxlZ2FsaXplKGMucikgKiAyNTUpLFxuICAgICAgICAgICAgZzogTWF0aC5mbG9vcihsZWdhbGl6ZShjLmcpICogMjU1KSxcbiAgICAgICAgICAgIGI6IE1hdGguZmxvb3IobGVnYWxpemUoYy5iKSAqIDI1NSlcbiAgICAgICAgfTtcbiAgICB9O1xuICAgIENvbG9yLndoaXRlID0gbmV3IENvbG9yKDEuMCwgMS4wLCAxLjApO1xuICAgIENvbG9yLmdyZXkgPSBuZXcgQ29sb3IoMC41LCAwLjUsIDAuNSk7XG4gICAgQ29sb3IuYmxhY2sgPSBuZXcgQ29sb3IoMC4wLCAwLjAsIDAuMCk7XG4gICAgQ29sb3IuYmFja2dyb3VuZCA9IENvbG9yLmJsYWNrO1xuICAgIENvbG9yLmRlZmF1bHRDb2xvciA9IENvbG9yLmJsYWNrO1xuICAgIHJldHVybiBDb2xvcjtcbn0oKSk7XG52YXIgQ2FtZXJhID0gKGZ1bmN0aW9uKCkge1xuICAgIGZ1bmN0aW9uIENhbWVyYShwb3MsIGxvb2tBdCkge1xuICAgICAgICB0aGlzLnBvcyA9IHBvcztcbiAgICAgICAgdmFyIGRvd24gPSBuZXcgVmVjdG9yKDAuMCwgLTEuMCwgMC4wKTtcbiAgICAgICAgdGhpcy5mb3J3YXJkID0gVmVjdG9yLm5vcm0oVmVjdG9yLm1pbnVzKGxvb2tBdCwgdGhpcy5wb3MpKTtcbiAgICAgICAgdGhpcy5yaWdodCA9IFZlY3Rvci50aW1lcygxLjUsIFZlY3Rvci5ub3JtKFZlY3Rvci5jcm9zcyh0aGlzLmZvcndhcmQsIGRvd24pKSk7XG4gICAgICAgIHRoaXMudXAgPSBWZWN0b3IudGltZXMoMS41LCBWZWN0b3Iubm9ybShWZWN0b3IuY3Jvc3ModGhpcy5mb3J3YXJkLCB0aGlzLnJpZ2h0KSkpO1xuICAgIH1cbiAgICByZXR1cm4gQ2FtZXJhO1xufSgpKTtcbnZhciBTcGhlcmUgPSAoZnVuY3Rpb24oKSB7XG4gICAgZnVuY3Rpb24gU3BoZXJlKGNlbnRlciwgcmFkaXVzLCBzdXJmYWNlKSB7XG4gICAgICAgIHRoaXMuY2VudGVyID0gY2VudGVyO1xuICAgICAgICB0aGlzLnN1cmZhY2UgPSBzdXJmYWNlO1xuICAgICAgICB0aGlzLnJhZGl1czIgPSByYWRpdXMgKiByYWRpdXM7XG4gICAgfVxuICAgIFNwaGVyZS5wcm90b3R5cGUubm9ybWFsID0gZnVuY3Rpb24ocG9zKSB7XG4gICAgICAgIHJldHVybiBWZWN0b3Iubm9ybShWZWN0b3IubWludXMocG9zLCB0aGlzLmNlbnRlcikpO1xuICAgIH07XG4gICAgU3BoZXJlLnByb3RvdHlwZS5pbnRlcnNlY3QgPSBmdW5jdGlvbihyYXkpIHtcbiAgICAgICAgdmFyIGVvID0gVmVjdG9yLm1pbnVzKHRoaXMuY2VudGVyLCByYXkuc3RhcnQpO1xuICAgICAgICB2YXIgdiA9IFZlY3Rvci5kb3QoZW8sIHJheS5kaXIpO1xuICAgICAgICB2YXIgZGlzdCA9IDA7XG4gICAgICAgIGlmICh2ID49IDApIHtcbiAgICAgICAgICAgIHZhciBkaXNjID0gdGhpcy5yYWRpdXMyIC0gKFZlY3Rvci5kb3QoZW8sIGVvKSAtIHYgKiB2KTtcbiAgICAgICAgICAgIGlmIChkaXNjID49IDApIHtcbiAgICAgICAgICAgICAgICBkaXN0ID0gdiAtIE1hdGguc3FydChkaXNjKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoZGlzdCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHRoaW5nOiB0aGlzLFxuICAgICAgICAgICAgICAgIHJheTogcmF5LFxuICAgICAgICAgICAgICAgIGRpc3Q6IGRpc3RcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICB9O1xuICAgIHJldHVybiBTcGhlcmU7XG59KCkpO1xudmFyIFBsYW5lID0gKGZ1bmN0aW9uKCkge1xuICAgIGZ1bmN0aW9uIFBsYW5lKG5vcm0sIG9mZnNldCwgc3VyZmFjZSkge1xuICAgICAgICB0aGlzLnN1cmZhY2UgPSBzdXJmYWNlO1xuICAgICAgICB0aGlzLm5vcm1hbCA9IGZ1bmN0aW9uKHBvcykge1xuICAgICAgICAgICAgcmV0dXJuIG5vcm07XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuaW50ZXJzZWN0ID0gZnVuY3Rpb24ocmF5KSB7XG4gICAgICAgICAgICB2YXIgZGVub20gPSBWZWN0b3IuZG90KG5vcm0sIHJheS5kaXIpO1xuICAgICAgICAgICAgaWYgKGRlbm9tID4gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YXIgZGlzdCA9IChWZWN0b3IuZG90KG5vcm0sIHJheS5zdGFydCkgKyBvZmZzZXQpIC8gKC1kZW5vbSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpbmc6IHRoaXMsXG4gICAgICAgICAgICAgICAgICAgIHJheTogcmF5LFxuICAgICAgICAgICAgICAgICAgICBkaXN0OiBkaXN0XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9XG4gICAgcmV0dXJuIFBsYW5lO1xufSgpKTtcbnZhciBTdXJmYWNlcztcbihmdW5jdGlvbihTdXJmYWNlcykge1xuICAgIFN1cmZhY2VzLnNoaW55ID0ge1xuICAgICAgICBkaWZmdXNlOiBmdW5jdGlvbihwb3MpIHtcbiAgICAgICAgICAgIHJldHVybiBDb2xvci53aGl0ZTtcbiAgICAgICAgfSxcbiAgICAgICAgc3BlY3VsYXI6IGZ1bmN0aW9uKHBvcykge1xuICAgICAgICAgICAgcmV0dXJuIENvbG9yLmdyZXk7XG4gICAgICAgIH0sXG4gICAgICAgIHJlZmxlY3Q6IGZ1bmN0aW9uKHBvcykge1xuICAgICAgICAgICAgcmV0dXJuIDAuNztcbiAgICAgICAgfSxcbiAgICAgICAgcm91Z2huZXNzOiAyNTBcbiAgICB9O1xuICAgIFN1cmZhY2VzLmNoZWNrZXJib2FyZCA9IHtcbiAgICAgICAgZGlmZnVzZTogZnVuY3Rpb24ocG9zKSB7XG4gICAgICAgICAgICBpZiAoKE1hdGguZmxvb3IocG9zLnopICsgTWF0aC5mbG9vcihwb3MueCkpICUgMiAhPT0gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBDb2xvci53aGl0ZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIENvbG9yLmJsYWNrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBzcGVjdWxhcjogZnVuY3Rpb24ocG9zKSB7XG4gICAgICAgICAgICByZXR1cm4gQ29sb3Iud2hpdGU7XG4gICAgICAgIH0sXG4gICAgICAgIHJlZmxlY3Q6IGZ1bmN0aW9uKHBvcykge1xuICAgICAgICAgICAgaWYgKChNYXRoLmZsb29yKHBvcy56KSArIE1hdGguZmxvb3IocG9zLngpKSAlIDIgIT09IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gMC4xO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gMC43O1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICByb3VnaG5lc3M6IDE1MFxuICAgIH07XG59KShTdXJmYWNlcyB8fCAoU3VyZmFjZXMgPSB7fSkpO1xudmFyIFJheVRyYWNlciA9IChmdW5jdGlvbigpIHtcbiAgICBmdW5jdGlvbiBSYXlUcmFjZXIoKSB7XG4gICAgICAgIHRoaXMubWF4RGVwdGggPSA1O1xuICAgIH1cbiAgICBSYXlUcmFjZXIucHJvdG90eXBlLmludGVyc2VjdGlvbnMgPSBmdW5jdGlvbihyYXksIHNjZW5lKSB7XG4gICAgICAgIHZhciBjbG9zZXN0ID0gK0luZmluaXR5O1xuICAgICAgICB2YXIgY2xvc2VzdEludGVyID0gdW5kZWZpbmVkO1xuICAgICAgICBmb3IgKHZhciBpIGluIHNjZW5lLnRoaW5ncykge1xuICAgICAgICAgICAgdmFyIGludGVyID0gc2NlbmUudGhpbmdzW2ldLmludGVyc2VjdChyYXkpO1xuICAgICAgICAgICAgaWYgKGludGVyICE9IG51bGwgJiYgaW50ZXIuZGlzdCA8IGNsb3Nlc3QpIHtcbiAgICAgICAgICAgICAgICBjbG9zZXN0SW50ZXIgPSBpbnRlcjtcbiAgICAgICAgICAgICAgICBjbG9zZXN0ID0gaW50ZXIuZGlzdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY2xvc2VzdEludGVyO1xuICAgIH07XG4gICAgUmF5VHJhY2VyLnByb3RvdHlwZS50ZXN0UmF5ID0gZnVuY3Rpb24ocmF5LCBzY2VuZSkge1xuICAgICAgICB2YXIgaXNlY3QgPSB0aGlzLmludGVyc2VjdGlvbnMocmF5LCBzY2VuZSk7XG4gICAgICAgIGlmIChpc2VjdCAhPSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gaXNlY3QuZGlzdDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIFJheVRyYWNlci5wcm90b3R5cGUudHJhY2VSYXkgPSBmdW5jdGlvbihyYXksIHNjZW5lLCBkZXB0aCkge1xuICAgICAgICB2YXIgaXNlY3QgPSB0aGlzLmludGVyc2VjdGlvbnMocmF5LCBzY2VuZSk7XG4gICAgICAgIGlmIChpc2VjdCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICByZXR1cm4gQ29sb3IuYmFja2dyb3VuZDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNoYWRlKGlzZWN0LCBzY2VuZSwgZGVwdGgpO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBSYXlUcmFjZXIucHJvdG90eXBlLnNoYWRlID0gZnVuY3Rpb24oaXNlY3QsIHNjZW5lLCBkZXB0aCkge1xuICAgICAgICB2YXIgZCA9IGlzZWN0LnJheS5kaXI7XG4gICAgICAgIHZhciBwb3MgPSBWZWN0b3IucGx1cyhWZWN0b3IudGltZXMoaXNlY3QuZGlzdCwgZCksIGlzZWN0LnJheS5zdGFydCk7XG4gICAgICAgIHZhciBub3JtYWwgPSBpc2VjdC50aGluZy5ub3JtYWwocG9zKTtcbiAgICAgICAgdmFyIHJlZmxlY3REaXIgPSBWZWN0b3IubWludXMoZCwgVmVjdG9yLnRpbWVzKDIsIFZlY3Rvci50aW1lcyhWZWN0b3IuZG90KG5vcm1hbCwgZCksIG5vcm1hbCkpKTtcbiAgICAgICAgdmFyIG5hdHVyYWxDb2xvciA9IENvbG9yLnBsdXMoQ29sb3IuYmFja2dyb3VuZCwgdGhpcy5nZXROYXR1cmFsQ29sb3IoaXNlY3QudGhpbmcsIHBvcywgbm9ybWFsLCByZWZsZWN0RGlyLCBzY2VuZSkpO1xuICAgICAgICB2YXIgcmVmbGVjdGVkQ29sb3IgPSAoZGVwdGggPj0gdGhpcy5tYXhEZXB0aCkgPyBDb2xvci5ncmV5IDogdGhpcy5nZXRSZWZsZWN0aW9uQ29sb3IoaXNlY3QudGhpbmcsIHBvcywgbm9ybWFsLCByZWZsZWN0RGlyLCBzY2VuZSwgZGVwdGgpO1xuICAgICAgICByZXR1cm4gQ29sb3IucGx1cyhuYXR1cmFsQ29sb3IsIHJlZmxlY3RlZENvbG9yKTtcbiAgICB9O1xuICAgIFJheVRyYWNlci5wcm90b3R5cGUuZ2V0UmVmbGVjdGlvbkNvbG9yID0gZnVuY3Rpb24odGhpbmcsIHBvcywgbm9ybWFsLCByZCwgc2NlbmUsIGRlcHRoKSB7XG4gICAgICAgIHJldHVybiBDb2xvci5zY2FsZSh0aGluZy5zdXJmYWNlLnJlZmxlY3QocG9zKSwgdGhpcy50cmFjZVJheSh7XG4gICAgICAgICAgICBzdGFydDogcG9zLFxuICAgICAgICAgICAgZGlyOiByZFxuICAgICAgICB9LCBzY2VuZSwgZGVwdGggKyAxKSk7XG4gICAgfTtcbiAgICBSYXlUcmFjZXIucHJvdG90eXBlLmdldE5hdHVyYWxDb2xvciA9IGZ1bmN0aW9uKHRoaW5nLCBwb3MsIG5vcm0sIHJkLCBzY2VuZSkge1xuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICB2YXIgYWRkTGlnaHQgPSBmdW5jdGlvbihjb2wsIGxpZ2h0KSB7XG4gICAgICAgICAgICB2YXIgbGRpcyA9IFZlY3Rvci5taW51cyhsaWdodC5wb3MsIHBvcyk7XG4gICAgICAgICAgICB2YXIgbGl2ZWMgPSBWZWN0b3Iubm9ybShsZGlzKTtcbiAgICAgICAgICAgIHZhciBuZWF0SXNlY3QgPSBfdGhpcy50ZXN0UmF5KHtcbiAgICAgICAgICAgICAgICBzdGFydDogcG9zLFxuICAgICAgICAgICAgICAgIGRpcjogbGl2ZWNcbiAgICAgICAgICAgIH0sIHNjZW5lKTtcbiAgICAgICAgICAgIHZhciBpc0luU2hhZG93ID0gKG5lYXRJc2VjdCA9PT0gdW5kZWZpbmVkKSA/IGZhbHNlIDogKG5lYXRJc2VjdCA8PSBWZWN0b3IubWFnKGxkaXMpKTtcbiAgICAgICAgICAgIGlmIChpc0luU2hhZG93KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvbDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFyIGlsbHVtID0gVmVjdG9yLmRvdChsaXZlYywgbm9ybSk7XG4gICAgICAgICAgICAgICAgdmFyIGxjb2xvciA9IChpbGx1bSA+IDApID8gQ29sb3Iuc2NhbGUoaWxsdW0sIGxpZ2h0LmNvbG9yKSA6IENvbG9yLmRlZmF1bHRDb2xvcjtcbiAgICAgICAgICAgICAgICB2YXIgc3BlY3VsYXIgPSBWZWN0b3IuZG90KGxpdmVjLCBWZWN0b3Iubm9ybShyZCkpO1xuICAgICAgICAgICAgICAgIHZhciBzY29sb3IgPSAoc3BlY3VsYXIgPiAwKSA/IENvbG9yLnNjYWxlKE1hdGgucG93KHNwZWN1bGFyLCB0aGluZy5zdXJmYWNlLnJvdWdobmVzcyksIGxpZ2h0LmNvbG9yKSA6IENvbG9yLmRlZmF1bHRDb2xvcjtcbiAgICAgICAgICAgICAgICByZXR1cm4gQ29sb3IucGx1cyhjb2wsIENvbG9yLnBsdXMoQ29sb3IudGltZXModGhpbmcuc3VyZmFjZS5kaWZmdXNlKHBvcyksIGxjb2xvciksIENvbG9yLnRpbWVzKHRoaW5nLnN1cmZhY2Uuc3BlY3VsYXIocG9zKSwgc2NvbG9yKSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gc2NlbmUubGlnaHRzLnJlZHVjZShhZGRMaWdodCwgQ29sb3IuZGVmYXVsdENvbG9yKTtcbiAgICB9O1xuICAgIFJheVRyYWNlci5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24oc2NlbmUsIGN0eCwgc2NyZWVuV2lkdGgsIHNjcmVlbkhlaWdodCkge1xuICAgICAgICB2YXIgZ2V0UG9pbnQgPSBmdW5jdGlvbih4LCB5LCBjYW1lcmEpIHtcbiAgICAgICAgICAgIHZhciByZWNlbnRlclggPSBmdW5jdGlvbih4KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICh4IC0gKHNjcmVlbldpZHRoIC8gMi4wKSkgLyAyLjAgLyBzY3JlZW5XaWR0aDtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB2YXIgcmVjZW50ZXJZID0gZnVuY3Rpb24oeSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAtKHkgLSAoc2NyZWVuSGVpZ2h0IC8gMi4wKSkgLyAyLjAgLyBzY3JlZW5IZWlnaHQ7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcmV0dXJuIFZlY3Rvci5ub3JtKFZlY3Rvci5wbHVzKGNhbWVyYS5mb3J3YXJkLCBWZWN0b3IucGx1cyhWZWN0b3IudGltZXMocmVjZW50ZXJYKHgpLCBjYW1lcmEucmlnaHQpLCBWZWN0b3IudGltZXMocmVjZW50ZXJZKHkpLCBjYW1lcmEudXApKSkpO1xuICAgICAgICB9O1xuICAgICAgICBmb3IgKHZhciB5ID0gMDsgeSA8IHNjcmVlbkhlaWdodDsgeSsrKSB7XG4gICAgICAgICAgICBmb3IgKHZhciB4ID0gMDsgeCA8IHNjcmVlbldpZHRoOyB4KyspIHtcbiAgICAgICAgICAgICAgICB2YXIgY29sb3IgPSB0aGlzLnRyYWNlUmF5KHtcbiAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHNjZW5lLmNhbWVyYS5wb3MsXG4gICAgICAgICAgICAgICAgICAgIGRpcjogZ2V0UG9pbnQoeCwgeSwgc2NlbmUuY2FtZXJhKVxuICAgICAgICAgICAgICAgIH0sIHNjZW5lLCAwKTtcbiAgICAgICAgICAgICAgICB2YXIgYyA9IENvbG9yLnRvRHJhd2luZ0NvbG9yKGNvbG9yKTtcbiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gXCJyZ2IoXCIgKyBTdHJpbmcoYy5yKSArIFwiLCBcIiArIFN0cmluZyhjLmcpICsgXCIsIFwiICsgU3RyaW5nKGMuYikgKyBcIilcIjtcbiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoeCwgeSwgeCArIDEsIHkgKyAxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG4gICAgcmV0dXJuIFJheVRyYWNlcjtcbn0oKSk7XG5cbmZ1bmN0aW9uIGRlZmF1bHRTY2VuZSgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgICB0aGluZ3M6IFtuZXcgUGxhbmUobmV3IFZlY3RvcigwLjAsIDEuMCwgMC4wKSwgMC4wLCBTdXJmYWNlcy5jaGVja2VyYm9hcmQpLFxuICAgICAgICAgICAgbmV3IFNwaGVyZShuZXcgVmVjdG9yKDAuMCwgMS4wLCAtMC4yNSksIDEuMCwgU3VyZmFjZXMuc2hpbnkpLFxuICAgICAgICAgICAgbmV3IFNwaGVyZShuZXcgVmVjdG9yKC0xLjAsIDAuNSwgMS41KSwgMC41LCBTdXJmYWNlcy5zaGlueSlcbiAgICAgICAgXSxcbiAgICAgICAgbGlnaHRzOiBbe1xuICAgICAgICAgICAgcG9zOiBuZXcgVmVjdG9yKC0yLjAsIDIuNSwgMC4wKSxcbiAgICAgICAgICAgIGNvbG9yOiBuZXcgQ29sb3IoMC40OSwgMC4wNywgMC4wNylcbiAgICAgICAgfSwge1xuICAgICAgICAgICAgcG9zOiBuZXcgVmVjdG9yKDEuNSwgMi41LCAxLjUpLFxuICAgICAgICAgICAgY29sb3I6IG5ldyBDb2xvcigwLjA3LCAwLjA3LCAwLjQ5KVxuICAgICAgICB9LCB7XG4gICAgICAgICAgICBwb3M6IG5ldyBWZWN0b3IoMS41LCAyLjUsIC0xLjUpLFxuICAgICAgICAgICAgY29sb3I6IG5ldyBDb2xvcigwLjA3LCAwLjQ5LCAwLjA3MSlcbiAgICAgICAgfSwge1xuICAgICAgICAgICAgcG9zOiBuZXcgVmVjdG9yKDAuMCwgMy41LCAwLjApLFxuICAgICAgICAgICAgY29sb3I6IG5ldyBDb2xvcigwLjIxLCAwLjIxLCAwLjM1KVxuICAgICAgICB9XSxcbiAgICAgICAgY2FtZXJhOiBuZXcgQ2FtZXJhKG5ldyBWZWN0b3IoMy4wLCAyLjAsIDQuMCksIG5ldyBWZWN0b3IoLTEuMCwgMC41LCAwLjApKVxuICAgIH07XG59XG5cbmZ1bmN0aW9uIGV4ZWMoKSB7XG4gICAgdmFyIGNhbnYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiY2FudmFzXCIpO1xuICAgIGNhbnYud2lkdGggPSAyNTY7XG4gICAgY2Fudi5oZWlnaHQgPSAyNTY7XG4gICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChjYW52KTtcbiAgICB2YXIgY3R4ID0gY2Fudi5nZXRDb250ZXh0KFwiMmRcIik7XG4gICAgdmFyIHJheVRyYWNlciA9IG5ldyBSYXlUcmFjZXIoKTtcbiAgICByZXR1cm4gcmF5VHJhY2VyLnJlbmRlcihkZWZhdWx0U2NlbmUoKSwgY3R4LCAyNTYsIDI1Nik7XG59XG5leGVjKCk7Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
